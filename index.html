<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RVM Dashboard</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
</head>
<body>

<header>
  <h1>RVM Dashboard</h1>
  <button class="enable-notif" id="notifBtn">Enable Notifications</button>
</header>

<main id="dashboard">
  <!-- Template card -->
  <section class="card" data-template="true" aria-label="RVM 1">
    <h2>
      <span class="rvm-title">RVM 1</span>
      <span class="rvm-location">-</span>
    </h2>
    <!-- Counts -->
    <div class="counts columns-3 row-counts">
      <div class="col">Plastic: <span class="plastic-val">-</span></div>
      <div class="col">Can: <span class="can-val">-</span></div>
      <div class="col">Total: <span class="total-val">-</span></div>
    </div>

    <!-- Volumes -->
    <div class="counts columns-3 row-volumes">
      <div class="col">Plastic Volume: <span class="plastic-text">-</span>%</div>
      <div class="col">Can Volume: <span class="can-text">-</span>%</div>
      <div class="col">Total Volume: <span class="total-text">-</span>%</div>
    </div>

    <!-- Bars -->
    <div class="bars">
      <div class="bar-container">
        <div class="bar"><div class="fill-plastic-bar" style="height:0%"></div></div>
        <div class="label">Plastic</div>
      </div>
      <div class="bar-container">
        <div class="bar"><div class="fill-can-bar" style="height:0%"></div></div>
        <div class="label">Can</div>
      </div>
      <div class="bar-container">
        <div class="bar"><div class="fill-total-bar" style="height:0%"></div></div>
        <div class="label">Total</div>
      </div>
    </div>
    <button class="history-btn" data-rvm="1">History</button>
  </section>
</main>

<!-- History overlay -->
<div id="backdrop" aria-hidden="true"></div>
<div id="historyContainer" aria-hidden="true">
  <div id="historyHeader">
    <h2>History for <span id="historyTitle">-</span></h2>
    <div><button id="closeHistory">Close</button></div>
  </div>
  <div id="historyBody">
    <!-- LEFT COLUMN -->
    <div class="left-column">
      <div class="chart-card">
        <div class="chart-title">Daily Chart</div>
        <canvas id="dailyChart"></canvas>
      </div>

      <div class="chart-card">
        <div class="chart-title">Weekly Chart</div>
        <canvas id="weeklyChart"></canvas>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="right-column">
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Plastic</th>
              <th>Can</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="historyTable"></tbody>
        </table>

        <div class="history-nav">
          <button id="prevWeekBtn" class="history-btn">⬅ Previous</button>
          <button id="nextWeekBtn" class="history-btn">Next ➡</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = "https://rvm.iffatadibamusaffa.workers.dev";
const SHEET_API = "https://script.google.com/macros/s/AKfycbwWp4pB_94dkI62JVTzkMlQVBMVoV-tTcNYcjexaWc7jeuTL6n4PYeXHurkKeHjCOpHuA/exec";
const DEPLOYED_DEVICE_COUNT = 4;
const FETCH_INTERVAL_MS = 5000;         // ngambil data setiap 5 detik
const NOTIFY_INTERVAL = 60 * 60 * 1000; // notif setiap 1 hour

function pctClamp(v){ v=Math.round(v); return isNaN(v)?0:Math.max(0,Math.min(100,v)); }

// Notifications enable/disable function
let lastNotifiedLevels = {};
function shouldNotify(key, level){
  const prev = lastNotifiedLevels[key];
  if(prev===undefined||level>prev){ lastNotifiedLevels[key]=level; return true;}
  return false;
}
function resetNotificationLevelIfLower(key, level){
  const prev=lastNotifiedLevels[key];
  if(prev!==undefined && level<prev) delete lastNotifiedLevels[key];
}
function sendNotification(title, body){
  if("Notification" in window && Notification.permission==="granted"){
    try{ new Notification(title,{body}); }catch(e){console.warn(e);}
  }
}
document.getElementById('notifBtn').addEventListener('click',()=>{
  if("Notification" in window) Notification.requestPermission().then(p=>alert(p==="granted"?"Notifications enabled!":"Notifications not granted."));
  else alert("Notifications not supported");
});

// Generate cards
function generateCards(count){
  const dashboard=document.getElementById('dashboard');
  const template=dashboard.querySelector('[data-template="true"]');
  
  for(let i=1;i<=count;i++){
    const clone = (i===1) ? template : template.cloneNode(true);
    clone.setAttribute('data-rvm',i);
    clone.querySelector('.rvm-title').innerText = `RVM ${i}`;
    clone.querySelector('.rvm-location').innerText = '-';
    
    // Reset counts
    clone.querySelector('.plastic-val').innerText='-';
    clone.querySelector('.can-val').innerText='-';
    clone.querySelector('.total-val').innerText='-';

    // Reset volume text
    clone.querySelector('.plastic-text').innerText='-';
    clone.querySelector('.can-text').innerText='-';
    clone.querySelector('.total-text').innerText='-';

    // Reset bars
    clone.querySelector('.fill-plastic-bar').style.height='0%';
    clone.querySelector('.fill-can-bar').style.height='0%';
    clone.querySelector('.fill-total-bar').style.height='0%';

    clone.querySelector('.history-btn').setAttribute('data-rvm',i);

    if(i!==1) dashboard.appendChild(clone);
  }

  template.removeAttribute('data-template'); // only needed once
}


// Update card values
function updateCardFromValues(cardEl, values){
  // Elements
  const plasticEl = cardEl.querySelector('.plastic-val');
  const canEl = cardEl.querySelector('.can-val');
  const totalEl = cardEl.querySelector('.total-val');

  const fillPlastic = cardEl.querySelector('.fill-plastic-bar');
  const fillCan = cardEl.querySelector('.fill-can-bar');
  const fillTotal = cardEl.querySelector('.fill-total-bar');

  const plasticText = cardEl.querySelector('.plastic-text');
  const canText = cardEl.querySelector('.can-text');
  const totalText = cardEl.querySelector('.total-text');

  // Values
  const plastic = Number(values.plastic) || 0;
  const can = Number(values.can) || 0;

  // Use pctClamp to ensure 0-100%
  const pPct = pctClamp(Number(values.pPct));
  const cPct = pctClamp(Number(values.cPct));

  // Total values
  const total = plastic + can;
  const totalPct = pctClamp(Math.round((pPct + cPct)/2)); // average of two

  // Update counts
  plasticEl.innerText = plastic;
  canEl.innerText = can;
  totalEl.innerText = total;

  // Update bars
  fillPlastic.style.height = pPct + '%';
  fillCan.style.height = cPct + '%';
  fillTotal.style.height = totalPct + '%';

  // Update text above bars
  plasticText.innerText = pPct;
  canText.innerText = cPct;
  totalText.innerText = totalPct;
}

// Fetch live counts
let fetchIntervalId=null;
let isFetchingCounts=false;
async function fetchCounts(){
  if(isFetchingCounts) return;
  isFetchingCounts=true;

  try {
    const resp = await fetch(API_URL, { cache: "no-store" });
    if (!resp.ok) throw new Error(resp.status);
    const data = await resp.json(); // now an array of objects

    data.forEach(device => {
      const rvmId = device.device_id.replace(/RVM/i,''); // extract number
      const card = document.querySelector(`.card[data-rvm="${rvmId}"]`);
      if(!card) return;

      const values = {
        plastic: Number(device.plastic || 0),
        can: Number(device.can || 0),
        pPct: Number(device.plasticVolume || 0),
        cPct: Number(device.canVolume || 0)
      };
      updateCardFromValues(card, values);
      const locationEl = card.querySelector('.rvm-location');
      if (locationEl) {
        locationEl.innerText = device.location || '-';
      }
      // Notification sends function
      ['plastic', 'can'].forEach(type => {const pct = Math.round(pctClamp(values[type === 'plastic' ? 'pPct' : 'cPct']));
      const key = `rvm${rvmId}-${type}`;
      const storageKey = `notify-${key}`;
      const now = Date.now();
      if (pct >= 75) {const lastSent = Number(localStorage.getItem(storageKey)) || 0;
        if (now - lastSent >= NOTIFY_INTERVAL) {
          sendNotification(
            `RVM ${rvmId} Volume Alert`,`${type.charAt(0).toUpperCase() + type.slice(1)} Threshold ${pct}% reached`);
            localStorage.setItem(storageKey, now);}
      } else {localStorage.removeItem(storageKey);} // reset when below threshold
    });
    });
  } catch(err){
    console.error("Error fetching counts:", err);
  }
  isFetchingCounts=false;
}
function startAutoFetch(){ if(fetchIntervalId) clearInterval(fetchIntervalId); fetchCounts().catch(console.error); fetchIntervalId=setInterval(fetchCounts,FETCH_INTERVAL_MS);}
function stopAutoFetch(){ if(fetchIntervalId) clearInterval(fetchIntervalId); fetchIntervalId=null;}

// History & Charts
let historyData=[], weekIndex=0, dailyChartInstance=null, weeklyChartInstance=null;
function fmtDate(rowDate){ if(typeof rowDate==='string'){if(rowDate.includes('T')) return rowDate.split('T')[0]; return rowDate;} return String(rowDate);}
function destroyCharts(){if(dailyChartInstance){try{dailyChartInstance.destroy();}catch(e){} dailyChartInstance=null;} if(weeklyChartInstance){try{weeklyChartInstance.destroy();}catch(e){} weeklyChartInstance=null;}}
function renderWeek(){
  const start=weekIndex*7;
  const weekData=historyData.slice(start,start+7);
  if(!weekData||weekData.length===0){document.getElementById('historyTable').innerHTML='<tr><td colspan="4">No data</td></tr>'; destroyCharts(); return;}
  const labels=weekData.map(r=>fmtDate(r.timestamp));
  const plasticSeries=weekData.map(r=>Number(r.plastic||0));
  const canSeries=weekData.map(r=>Number(r.can||0));
  const totalDaily=weekData.map(r=>Number(r.plastic+r.can||0));
  const totals=plasticSeries.map((p,i)=>p+(canSeries[i]||0));
  const weeklyTotal=totals.reduce((s,v)=>s+v,0);

  destroyCharts();
  dailyChartInstance=new Chart(document.getElementById('dailyChart').getContext('2d'),{
    type:'line',
    data:{ labels, datasets:[{label:'Plastic',data:plasticSeries,stack:'stack1',borderColor:'#3b82f6',backgroundColor:'#3b82f6'},{label:'Can',data:canSeries,stack:'stack2',borderColor:'#f59e0b',backgroundColor:'#f59e0b'},{label:'Total',data:totalDaily,stack:'stack3',borderColor:'#10b981',backgroundColor:'#10b981'}]},
    options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false}, plugins:{legend:{position:'top'}}, scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true,ticks:{precision:0}}}, datasets:{bar:{maxBarThickness:48}} }
  });
  weeklyChartInstance=new Chart(document.getElementById('weeklyChart').getContext('2d'),{
    type:'bar',
    data:{ labels:['Plastic','Can','Total'], datasets:[{label:'7-day totals',data:[plasticSeries.reduce((a,b)=>a+b,0),canSeries.reduce((a,b)=>a+b,0),weeklyTotal],borderRadius:6,backgroundColor: ['#3b82f6','#f59e0b','#10b981']}]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{precision:0}}} }
  });

  const tableBody=document.getElementById('historyTable'); tableBody.innerHTML='';
  weekData.forEach(row=>{ const p=Number(row.plastic||0), c=Number(row.can||0); tableBody.innerHTML+=`<tr><td>${fmtDate(row.timestamp)}</td><td>${p}</td><td>${c}</td><td>${p+c}</td></tr>`; });

  document.getElementById('nextWeekBtn').disabled=((start+7)>=historyData.length);
  document.getElementById('prevWeekBtn').disabled=(weekIndex===0);
}

async function showHistory(rvmId){
  document.getElementById('backdrop').style.display='block';
  const hist=document.getElementById('historyContainer'); hist.style.display='block'; hist.setAttribute('aria-hidden','false');
  document.getElementById('historyTitle').innerText=`RVM ${rvmId}`;
  const tableBody=document.getElementById('historyTable'); tableBody.innerHTML='<tr><td colspan="4">Loading...</td></tr>';
  try{
    const response=await fetch(`${SHEET_API}?bin=${encodeURIComponent(rvmId)}`,{cache:"no-store"});
    if(!response.ok) throw new Error(response.status);
    let data=await response.json();
    if(!Array.isArray(data)){ if(typeof data==='object' && data!==null){ data=Object.keys(data).map(k=>{ const v=data[k]; return {date:k, plastic:v.plastic||v.p, can:v.can||v.c};});} else data=[];}
    historyData = data
      .filter(row => row.device_id === `RVM${rvmId}`)
      .sort((a,b)=> new Date(a.timestamp) - new Date(b.timestamp));
    weekIndex=0; renderWeek();
    document.getElementById("nextWeekBtn").onclick=()=>{if((weekIndex+1)*7<historyData.length){weekIndex++;renderWeek();}};
    document.getElementById("prevWeekBtn").onclick=()=>{if(weekIndex>0){weekIndex--;renderWeek();}};
  }catch(err){console.error("History fetch error:",err); tableBody.innerHTML='<tr><td colspan="4">Error loading history.</td></tr>'; destroyCharts();}
}

function closeHistory(){document.getElementById('backdrop').style.display='none'; const hist=document.getElementById('historyContainer'); hist.style.display='none'; hist.setAttribute('aria-hidden','true'); destroyCharts();}

document.addEventListener('click',function(e){const btn=e.target.closest('.history-btn'); if(btn){const rvm=Number(btn.getAttribute('data-rvm'))||Number(btn.closest('.card').getAttribute('data-rvm')); if(rvm) showHistory(rvm);}});
document.getElementById('closeHistory').addEventListener('click',closeHistory);
document.getElementById('backdrop').addEventListener('click',closeHistory);

window.addEventListener('DOMContentLoaded',()=>{
  generateCards(DEPLOYED_DEVICE_COUNT);
  startAutoFetch();
});
document.addEventListener('visibilitychange',()=>{document.hidden?stopAutoFetch():startAutoFetch();});
</script>

</body>
</html>



